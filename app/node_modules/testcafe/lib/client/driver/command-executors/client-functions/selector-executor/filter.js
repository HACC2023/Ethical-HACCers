"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../../../../../shared/errors/index");
const utils_1 = require("./utils");
// @ts-ignore
const hammerhead_1 = require("../../../deps/hammerhead");
// @ts-ignore
const testcafe_core_1 = require("../../../deps/testcafe-core");
const SELECTOR_FILTER_ERROR = {
    filterVisible: 1,
    filterHidden: 2,
    nth: 3,
};
const FILTER_ERROR_TO_API_RE = {
    [SELECTOR_FILTER_ERROR.filterVisible]: /^\.filterVisible\(\)$/,
    [SELECTOR_FILTER_ERROR.filterHidden]: /^\.filterHidden\(\)$/,
    [SELECTOR_FILTER_ERROR.nth]: /^\.nth\(\d+\)$/,
};
class SelectorFilter {
    constructor() {
        this._err = null;
    }
    get error() {
        return this._err;
    }
    set error(message) {
        if (this._err === null)
            this._err = message;
    }
    filter(nodes, options, apiInfo) {
        if (options.filterVisible) {
            nodes = nodes.filter(testcafe_core_1.positionUtils.isElementVisible);
            this._assertFilterError(nodes, apiInfo, SELECTOR_FILTER_ERROR.filterVisible);
        }
        if (options.filterHidden) {
            nodes = nodes.filter(n => !testcafe_core_1.positionUtils.isElementVisible(n));
            this._assertFilterError(nodes, apiInfo, SELECTOR_FILTER_ERROR.filterHidden);
        }
        if (options.counterMode) {
            if (options.index === null)
                return nodes.length;
            return SelectorFilter._getNodeByIndex(nodes, options.index) ? 1 : 0;
        }
        if (options.collectionMode) {
            if (options.index !== null) {
                const nodeOnIndex = SelectorFilter._getNodeByIndex(nodes, options.index);
                nodes = nodeOnIndex ? [nodeOnIndex] : [];
                this._assertFilterError(nodes, apiInfo, SELECTOR_FILTER_ERROR.nth);
            }
            return nodes;
        }
        const nodeOnIndex = SelectorFilter._getNodeByIndex(nodes, options.index || 0);
        if (!nodeOnIndex)
            this.error = SelectorFilter._getErrorItem(apiInfo, SELECTOR_FILTER_ERROR.nth);
        return nodeOnIndex;
    }
    cast(searchResult) {
        if (searchResult === null || searchResult === void 0)
            return [];
        else if (searchResult instanceof hammerhead_1.nativeMethods.Node)
            return [searchResult];
        else if ((0, utils_1.isArrayOfNodes)(searchResult))
            return searchResult;
        else if ((0, utils_1.isNodeCollection)(searchResult))
            return (0, utils_1.castToArray)(searchResult);
        throw new index_1.InvalidSelectorResultError();
    }
    _assertFilterError(filtered, apiInfo, filterError) {
        if (filtered.length === 0)
            this.error = SelectorFilter._getErrorItem(apiInfo, filterError);
    }
    static _getErrorItem({ apiFnChain, apiFnID }, err) {
        if (err) {
            for (let i = apiFnID; i < apiFnChain.length; i++) {
                if (FILTER_ERROR_TO_API_RE[err].test(apiFnChain[i]))
                    return i;
            }
        }
        return null;
    }
    static _getNodeByIndex(nodes, index) {
        return index < 0 ? nodes[nodes.length + index] : nodes[index];
    }
}
exports.default = new SelectorFilter();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9kcml2ZXIvY29tbWFuZC1leGVjdXRvcnMvY2xpZW50LWZ1bmN0aW9ucy9zZWxlY3Rvci1leGVjdXRvci9maWx0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4REFBZ0Y7QUFDaEYsbUNBSWlCO0FBRWpCLGFBQWE7QUFDYix5REFBeUQ7QUFDekQsYUFBYTtBQUNiLCtEQUE0RDtBQUc1RCxNQUFNLHFCQUFxQixHQUFHO0lBQzFCLGFBQWEsRUFBRSxDQUFDO0lBQ2hCLFlBQVksRUFBRyxDQUFDO0lBQ2hCLEdBQUcsRUFBWSxDQUFDO0NBQ25CLENBQUM7QUFFRixNQUFNLHNCQUFzQixHQUFHO0lBQzNCLENBQUMscUJBQXFCLENBQUMsYUFBYSxDQUFDLEVBQUUsdUJBQXVCO0lBQzlELENBQUMscUJBQXFCLENBQUMsWUFBWSxDQUFDLEVBQUcsc0JBQXNCO0lBQzdELENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLEVBQVksZ0JBQWdCO0NBQzFELENBQUM7QUFHRixNQUFNLGNBQWM7SUFBcEI7UUFDWSxTQUFJLEdBQWtCLElBQUksQ0FBQztJQXNGdkMsQ0FBQztJQXBGRyxJQUFXLEtBQUs7UUFDWixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDckIsQ0FBQztJQUVELElBQVcsS0FBSyxDQUFFLE9BQXNCO1FBQ3BDLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxJQUFJO1lBQ2xCLElBQUksQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDO0lBQzVCLENBQUM7SUFFTSxNQUFNLENBQUUsS0FBYSxFQUFFLE9BQXNCLEVBQUUsT0FBZ0I7UUFDbEUsSUFBSSxPQUFPLENBQUMsYUFBYSxFQUFFO1lBQ3ZCLEtBQUssR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLDZCQUFhLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUVyRCxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxxQkFBcUIsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUNoRjtRQUVELElBQUksT0FBTyxDQUFDLFlBQVksRUFBRTtZQUN0QixLQUFLLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsNkJBQWEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRTlELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLHFCQUFxQixDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQy9FO1FBRUQsSUFBSSxPQUFPLENBQUMsV0FBVyxFQUFFO1lBQ3JCLElBQUksT0FBTyxDQUFDLEtBQUssS0FBSyxJQUFJO2dCQUN0QixPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUM7WUFFeEIsT0FBTyxjQUFjLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3ZFO1FBRUQsSUFBSSxPQUFPLENBQUMsY0FBYyxFQUFFO1lBQ3hCLElBQUksT0FBTyxDQUFDLEtBQUssS0FBSyxJQUFJLEVBQUU7Z0JBQ3hCLE1BQU0sV0FBVyxHQUFHLGNBQWMsQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFFekUsS0FBSyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO2dCQUV6QyxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxxQkFBcUIsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUN0RTtZQUVELE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBRUQsTUFBTSxXQUFXLEdBQUcsY0FBYyxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztRQUU5RSxJQUFJLENBQUMsV0FBVztZQUNaLElBQUksQ0FBQyxLQUFLLEdBQUcsY0FBYyxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUscUJBQXFCLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFbEYsT0FBTyxXQUFXLENBQUM7SUFDdkIsQ0FBQztJQUVNLElBQUksQ0FBRSxZQUFxQjtRQUM5QixJQUFJLFlBQVksS0FBSyxJQUFJLElBQUksWUFBWSxLQUFLLEtBQUssQ0FBQztZQUNoRCxPQUFPLEVBQUUsQ0FBQzthQUVULElBQUksWUFBWSxZQUFZLDBCQUFhLENBQUMsSUFBSTtZQUMvQyxPQUFPLENBQUMsWUFBb0IsQ0FBQyxDQUFDO2FBRTdCLElBQUksSUFBQSxzQkFBYyxFQUFDLFlBQVksQ0FBQztZQUNqQyxPQUFPLFlBQVksQ0FBQzthQUVuQixJQUFJLElBQUEsd0JBQWdCLEVBQUMsWUFBWSxDQUFDO1lBQ25DLE9BQU8sSUFBQSxtQkFBVyxFQUFDLFlBQVksQ0FBQyxDQUFDO1FBRXJDLE1BQU0sSUFBSSxrQ0FBMEIsRUFBRSxDQUFDO0lBQzNDLENBQUM7SUFFTyxrQkFBa0IsQ0FBRSxRQUFnQixFQUFFLE9BQWdCLEVBQUUsV0FBbUI7UUFDL0UsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUM7WUFDckIsSUFBSSxDQUFDLEtBQUssR0FBRyxjQUFjLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBRU8sTUFBTSxDQUFDLGFBQWEsQ0FBRSxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQVcsRUFBRSxHQUFXO1FBQ3ZFLElBQUksR0FBRyxFQUFFO1lBQ0wsS0FBSyxJQUFJLENBQUMsR0FBRyxPQUFPLEVBQUUsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQzlDLElBQUksc0JBQXNCLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDL0MsT0FBTyxDQUFDLENBQUM7YUFDaEI7U0FDSjtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTyxNQUFNLENBQUMsZUFBZSxDQUFFLEtBQWEsRUFBRSxLQUFhO1FBQ3hELE9BQU8sS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNsRSxDQUFDO0NBQ0o7QUFFRCxrQkFBZSxJQUFJLGNBQWMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW52YWxpZFNlbGVjdG9yUmVzdWx0RXJyb3IgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9zaGFyZWQvZXJyb3JzL2luZGV4JztcbmltcG9ydCB7XG4gICAgaXNOb2RlQ29sbGVjdGlvbixcbiAgICBpc0FycmF5T2ZOb2RlcyxcbiAgICBjYXN0VG9BcnJheSxcbn0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgeyBBUElJbmZvLCBGaWx0ZXJPcHRpb25zIH0gZnJvbSAnLi4vdHlwZXMnO1xuLy8gQHRzLWlnbm9yZVxuaW1wb3J0IHsgbmF0aXZlTWV0aG9kcyB9IGZyb20gJy4uLy4uLy4uL2RlcHMvaGFtbWVyaGVhZCc7XG4vLyBAdHMtaWdub3JlXG5pbXBvcnQgeyBwb3NpdGlvblV0aWxzIH0gZnJvbSAnLi4vLi4vLi4vZGVwcy90ZXN0Y2FmZS1jb3JlJztcblxuXG5jb25zdCBTRUxFQ1RPUl9GSUxURVJfRVJST1IgPSB7XG4gICAgZmlsdGVyVmlzaWJsZTogMSxcbiAgICBmaWx0ZXJIaWRkZW46ICAyLFxuICAgIG50aDogICAgICAgICAgIDMsXG59O1xuXG5jb25zdCBGSUxURVJfRVJST1JfVE9fQVBJX1JFID0ge1xuICAgIFtTRUxFQ1RPUl9GSUxURVJfRVJST1IuZmlsdGVyVmlzaWJsZV06IC9eXFwuZmlsdGVyVmlzaWJsZVxcKFxcKSQvLFxuICAgIFtTRUxFQ1RPUl9GSUxURVJfRVJST1IuZmlsdGVySGlkZGVuXTogIC9eXFwuZmlsdGVySGlkZGVuXFwoXFwpJC8sXG4gICAgW1NFTEVDVE9SX0ZJTFRFUl9FUlJPUi5udGhdOiAgICAgICAgICAgL15cXC5udGhcXChcXGQrXFwpJC8sXG59O1xuXG5cbmNsYXNzIFNlbGVjdG9yRmlsdGVyIHtcbiAgICBwcml2YXRlIF9lcnI6IG51bWJlciB8IG51bGwgPSBudWxsO1xuXG4gICAgcHVibGljIGdldCBlcnJvciAoKTogbnVtYmVyIHwgbnVsbCB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lcnI7XG4gICAgfVxuXG4gICAgcHVibGljIHNldCBlcnJvciAobWVzc2FnZTogbnVtYmVyIHwgbnVsbCkge1xuICAgICAgICBpZiAodGhpcy5fZXJyID09PSBudWxsKVxuICAgICAgICAgICAgdGhpcy5fZXJyID0gbWVzc2FnZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZmlsdGVyIChub2RlczogTm9kZVtdLCBvcHRpb25zOiBGaWx0ZXJPcHRpb25zLCBhcGlJbmZvOiBBUElJbmZvKTogbnVtYmVyIHwgTm9kZSB8IE5vZGVbXSB8IHVuZGVmaW5lZCB7XG4gICAgICAgIGlmIChvcHRpb25zLmZpbHRlclZpc2libGUpIHtcbiAgICAgICAgICAgIG5vZGVzID0gbm9kZXMuZmlsdGVyKHBvc2l0aW9uVXRpbHMuaXNFbGVtZW50VmlzaWJsZSk7XG5cbiAgICAgICAgICAgIHRoaXMuX2Fzc2VydEZpbHRlckVycm9yKG5vZGVzLCBhcGlJbmZvLCBTRUxFQ1RPUl9GSUxURVJfRVJST1IuZmlsdGVyVmlzaWJsZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob3B0aW9ucy5maWx0ZXJIaWRkZW4pIHtcbiAgICAgICAgICAgIG5vZGVzID0gbm9kZXMuZmlsdGVyKG4gPT4gIXBvc2l0aW9uVXRpbHMuaXNFbGVtZW50VmlzaWJsZShuKSk7XG5cbiAgICAgICAgICAgIHRoaXMuX2Fzc2VydEZpbHRlckVycm9yKG5vZGVzLCBhcGlJbmZvLCBTRUxFQ1RPUl9GSUxURVJfRVJST1IuZmlsdGVySGlkZGVuKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHRpb25zLmNvdW50ZXJNb2RlKSB7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5pbmRleCA9PT0gbnVsbClcbiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZXMubGVuZ3RoO1xuXG4gICAgICAgICAgICByZXR1cm4gU2VsZWN0b3JGaWx0ZXIuX2dldE5vZGVCeUluZGV4KG5vZGVzLCBvcHRpb25zLmluZGV4KSA/IDEgOiAwO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG9wdGlvbnMuY29sbGVjdGlvbk1vZGUpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLmluZGV4ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgbm9kZU9uSW5kZXggPSBTZWxlY3RvckZpbHRlci5fZ2V0Tm9kZUJ5SW5kZXgobm9kZXMsIG9wdGlvbnMuaW5kZXgpO1xuXG4gICAgICAgICAgICAgICAgbm9kZXMgPSBub2RlT25JbmRleCA/IFtub2RlT25JbmRleF0gOiBbXTtcblxuICAgICAgICAgICAgICAgIHRoaXMuX2Fzc2VydEZpbHRlckVycm9yKG5vZGVzLCBhcGlJbmZvLCBTRUxFQ1RPUl9GSUxURVJfRVJST1IubnRoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIG5vZGVzO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgbm9kZU9uSW5kZXggPSBTZWxlY3RvckZpbHRlci5fZ2V0Tm9kZUJ5SW5kZXgobm9kZXMsIG9wdGlvbnMuaW5kZXggfHwgMCk7XG5cbiAgICAgICAgaWYgKCFub2RlT25JbmRleClcbiAgICAgICAgICAgIHRoaXMuZXJyb3IgPSBTZWxlY3RvckZpbHRlci5fZ2V0RXJyb3JJdGVtKGFwaUluZm8sIFNFTEVDVE9SX0ZJTFRFUl9FUlJPUi5udGgpO1xuXG4gICAgICAgIHJldHVybiBub2RlT25JbmRleDtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2FzdCAoc2VhcmNoUmVzdWx0OiB1bmtub3duKTogTm9kZVtdIHtcbiAgICAgICAgaWYgKHNlYXJjaFJlc3VsdCA9PT0gbnVsbCB8fCBzZWFyY2hSZXN1bHQgPT09IHZvaWQgMClcbiAgICAgICAgICAgIHJldHVybiBbXTtcblxuICAgICAgICBlbHNlIGlmIChzZWFyY2hSZXN1bHQgaW5zdGFuY2VvZiBuYXRpdmVNZXRob2RzLk5vZGUpXG4gICAgICAgICAgICByZXR1cm4gW3NlYXJjaFJlc3VsdCBhcyBOb2RlXTtcblxuICAgICAgICBlbHNlIGlmIChpc0FycmF5T2ZOb2RlcyhzZWFyY2hSZXN1bHQpKVxuICAgICAgICAgICAgcmV0dXJuIHNlYXJjaFJlc3VsdDtcblxuICAgICAgICBlbHNlIGlmIChpc05vZGVDb2xsZWN0aW9uKHNlYXJjaFJlc3VsdCkpXG4gICAgICAgICAgICByZXR1cm4gY2FzdFRvQXJyYXkoc2VhcmNoUmVzdWx0KTtcblxuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZFNlbGVjdG9yUmVzdWx0RXJyb3IoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9hc3NlcnRGaWx0ZXJFcnJvciAoZmlsdGVyZWQ6IE5vZGVbXSwgYXBpSW5mbzogQVBJSW5mbywgZmlsdGVyRXJyb3I6IG51bWJlcik6IHZvaWQge1xuICAgICAgICBpZiAoZmlsdGVyZWQubGVuZ3RoID09PSAwKVxuICAgICAgICAgICAgdGhpcy5lcnJvciA9IFNlbGVjdG9yRmlsdGVyLl9nZXRFcnJvckl0ZW0oYXBpSW5mbywgZmlsdGVyRXJyb3IpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIF9nZXRFcnJvckl0ZW0gKHsgYXBpRm5DaGFpbiwgYXBpRm5JRCB9OiBBUElJbmZvLCBlcnI6IG51bWJlcik6IG51bWJlciB8IG51bGwge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gYXBpRm5JRDsgaSA8IGFwaUZuQ2hhaW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoRklMVEVSX0VSUk9SX1RPX0FQSV9SRVtlcnJdLnRlc3QoYXBpRm5DaGFpbltpXSkpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2dldE5vZGVCeUluZGV4IChub2RlczogTm9kZVtdLCBpbmRleDogbnVtYmVyKTogTm9kZSB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiBpbmRleCA8IDAgPyBub2Rlc1tub2Rlcy5sZW5ndGggKyBpbmRleF0gOiBub2Rlc1tpbmRleF07XG4gICAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBuZXcgU2VsZWN0b3JGaWx0ZXIoKTtcbiJdfQ==