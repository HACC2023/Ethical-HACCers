"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getTypeScriptTestListFromCode = exports.getTypeScriptTestList = void 0;
const typescript_1 = __importDefault(require("typescript"));
const lodash_1 = require("lodash");
const test_file_parser_base_1 = require("../../test-file-parser-base");
const typescript_configuration_1 = __importDefault(require("../../../../configuration/typescript-configuration"));
function replaceComments(code) {
    return code.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm, match => {
        const lastSymbol = match.indexOf('\n') > -1 ? '\n' : ' ';
        return (0, lodash_1.repeat)(' ', match.length + lastSymbol);
    });
}
class TypeScriptTestFileParser extends test_file_parser_base_1.TestFileParserBase {
    constructor() {
        super(typescript_1.default.SyntaxKind);
    }
    getComputedNameString({ pos, end }) {
        const templatePos = this.getLocationByOffsets(pos, end);
        return test_file_parser_base_1.TestFileParserBase.formatComputedName(templatePos.loc.start.line);
    }
    getTokenType(token) {
        return token.kind;
    }
    getCalleeToken(token) {
        return token.expression;
    }
    getMemberFnName(token) {
        return token.expression.name.text;
    }
    getKeyValue(prop) {
        const { name, initializer } = prop;
        return {
            key: name.text,
            value: this.getStringValue(initializer),
        };
    }
    getFixedStartOffset(start) {
        let fixedStartOffset = start;
        while (/\s/.test(this.codeWithoutComments[fixedStartOffset]))
            ++fixedStartOffset;
        return fixedStartOffset;
    }
    getLocationByOffsets(start, end) {
        const fixedStart = this.getFixedStartOffset(start);
        const codeArr = this.codeArr;
        const loc = { start: null, end: null };
        let line = codeArr[0];
        let startTmp = fixedStart;
        let endTmp = end;
        for (let lineNumber = 1; lineNumber <= codeArr.length; ++lineNumber, line = codeArr[lineNumber - 1]) {
            startTmp -= line.length + 1;
            endTmp -= line.length + 1;
            if (startTmp < 0 && !loc.start)
                loc.start = { line: lineNumber, column: line.length + startTmp + 1 };
            if (endTmp <= 0 || lineNumber === codeArr.length - 1) {
                loc.end = { line: lineNumber, column: line.length + endTmp + 1 };
                break;
            }
        }
        return { loc, start: fixedStart, end };
    }
    getRValue(token) {
        return token.declarationList.declarations[0].initializer;
    }
    getStringValue(token) {
        const stringTypes = [this.tokenType.StringLiteral, this.tokenType.TemplateExpression];
        if (stringTypes.indexOf(token.kind) > -1 || token.text && token.kind !== this.tokenType.NumericLiteral)
            return this.formatFnArg(token);
        return null;
    }
    isAsyncFn(token) {
        const isGeneratorFn = !!token.asteriskToken;
        const isAsyncFn = token.modifiers &&
            token.modifiers.some(modifier => modifier.kind === this.tokenType.AsyncKeyword);
        return isGeneratorFn || isAsyncFn;
    }
    getFunctionBody(token) {
        return token.body.statements;
    }
    formatFnData(name, value, token, meta = [{}]) {
        const loc = this.getLocationByOffsets(token.pos, token.end);
        return {
            fnName: name,
            value: value,
            loc: loc.loc,
            start: loc.start,
            end: loc.end,
            meta: (0, lodash_1.merge)({}, ...meta),
            isSkipped: test_file_parser_base_1.TestFileParserBase.isSkipped(token),
        };
    }
    analyzeMemberExp(token) {
        let exp = token;
        const tokenType = this.tokenType;
        const callStack = [exp];
        while (exp.kind !== this.tokenType.Identifier) {
            exp = exp.expression || exp.tag;
            callStack.push(exp);
        }
        const meta = this.getMetaInfo(callStack.slice());
        if (exp && this.isApiFn(exp.text)) {
            let parentExp = callStack.pop();
            while (parentExp) {
                if (parentExp.kind === tokenType.CallExpression && parentExp.expression) {
                    const calleeType = parentExp.expression.kind;
                    const calleeMemberFn = calleeType === tokenType.PropertyAccessExpression &&
                        parentExp.expression.name.text;
                    if (this.checkExpDefineTargetName(calleeType, calleeMemberFn))
                        return this.formatFnData(exp.text, this.formatFnArg(parentExp.arguments[0]), token, meta);
                }
                if (parentExp.kind === tokenType.TaggedTemplateExpression && parentExp.tag) {
                    const tagType = parentExp.tag.kind;
                    const tagMemberFn = tagType === tokenType.PropertyAccessExpression && parentExp.tag.name.text;
                    if (this.checkExpDefineTargetName(tagType, tagMemberFn))
                        return this.formatFnData(exp.text, this.formatFnArg(parentExp), token, meta);
                }
                parentExp = callStack.pop();
            }
        }
        return null;
    }
    formatFnArg(arg) {
        if (arg.templateSpans)
            return this.getComputedNameString({ pos: arg.pos, end: arg.end });
        if (arg.head)
            return this.getComputedNameString({ pos: arg.template.pos, end: arg.template.end });
        if (arg.template)
            return arg.template.text || this.getComputedNameString({ pos: arg.template.pos, end: arg.template.end });
        if (arg.kind === this.tokenType.Identifier)
            return this.getComputedNameString({ pos: arg.pos, end: arg.end });
        if (arg.text && arg.kind !== this.tokenType.NumericLiteral)
            return arg.text;
        if (arg.kind === this.tokenType.TypeAssertionExpression)
            return this.formatFnArg(arg.expression);
        return null;
    }
    getFnCall(token) {
        if (this.isApiFn(token.expression.text))
            return this.formatFnData(token.expression.text, this.formatFnArg(token.arguments[0]), token);
        return null;
    }
    getTaggedTemplateExp(token) {
        if (this.isApiFn(token.tag.text))
            return this.formatFnData(token.tag.text, this.formatFnArg(token), token);
        return null;
    }
    analyzeFnCall(token) {
        const tokenType = this.tokenType;
        if (token.kind === tokenType.PropertyAccessExpression)
            return this.analyzeMemberExp(token);
        if (token.kind === tokenType.CallExpression) {
            const expKind = token.expression.kind;
            if (expKind === tokenType.PropertyAccessExpression || expKind === tokenType.CallExpression)
                return this.analyzeMemberExp(token);
            if (expKind === tokenType.ParenthesizedExpression)
                return this.analyzeFnCall(token.expression.expression);
            return this.getFnCall(token);
        }
        if (token.kind === tokenType.FunctionExpression || token.kind === tokenType.ArrowFunction)
            return this.collectTestCafeCalls(this.getFunctionBody(token));
        if (token.kind === tokenType.TaggedTemplateExpression) {
            if (token.tag.kind === tokenType.PropertyAccessExpression || token.tag.kind === tokenType.CallExpression)
                return this.analyzeMemberExp(token);
            return this.getTaggedTemplateExp(token);
        }
        return null;
    }
    parse(code) {
        //NOTE: TypeScript calculates start position of a token incorrectly
        //It doesn't consider spaces and comments between the last token and the current token.
        //So we replace comments with space symbols to calculate fixed position.
        //We just increment position until we meet non whitespace characters
        this.codeArr = code.split('\n');
        this.codeWithoutComments = replaceComments(code);
        const tsConfig = new typescript_configuration_1.default();
        const sourceFile = typescript_1.default.createSourceFile('', code, tsConfig.getOptions(), true);
        return this.analyze(sourceFile.statements);
    }
}
const parser = new TypeScriptTestFileParser();
exports.getTypeScriptTestList = parser.getTestList.bind(parser);
exports.getTypeScriptTestListFromCode = parser.getTestListFromCode.bind(parser);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LXRlc3QtbGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9jb21waWxlci90ZXN0LWZpbGUvZm9ybWF0cy90eXBlc2NyaXB0L2dldC10ZXN0LWxpc3QuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNERBQTRCO0FBQzVCLG1DQUF1QztBQUN2Qyx1RUFBaUU7QUFDakUsa0hBQXlGO0FBRXpGLFNBQVMsZUFBZSxDQUFFLElBQUk7SUFDMUIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLHNDQUFzQyxFQUFFLEtBQUssQ0FBQyxFQUFFO1FBQ2hFLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO1FBRXpELE9BQU8sSUFBQSxlQUFNLEVBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDLENBQUM7SUFDbEQsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBRUQsTUFBTSx3QkFBeUIsU0FBUSwwQ0FBa0I7SUFDckQ7UUFDSSxLQUFLLENBQUMsb0JBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN6QixDQUFDO0lBRUQscUJBQXFCLENBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFO1FBQy9CLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFFeEQsT0FBTywwQ0FBa0IsQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3RSxDQUFDO0lBRUQsWUFBWSxDQUFFLEtBQUs7UUFDZixPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUM7SUFDdEIsQ0FBQztJQUVELGNBQWMsQ0FBRSxLQUFLO1FBQ2pCLE9BQU8s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QUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUMzQztRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxLQUFLLENBQUUsSUFBSTtRQUNQLG1FQUFtRTtRQUNuRSx1RkFBdUY7UUFDdkYsd0VBQXdFO1FBQ3hFLG9FQUFvRTtRQUNwRSxJQUFJLENBQUMsT0FBTyxHQUFlLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVqRCxNQUFNLFFBQVEsR0FBSyxJQUFJLGtDQUF1QixFQUFFLENBQUM7UUFDakQsTUFBTSxVQUFVLEdBQUcsb0JBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxVQUFVLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUU5RSxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQy9DLENBQUM7Q0FDSjtBQUVELE1BQU0sTUFBTSxHQUFHLElBQUksd0JBQXdCLEVBQUUsQ0FBQztBQUVqQyxRQUFBLHFCQUFxQixHQUFXLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ2hFLFFBQUEsNkJBQTZCLEdBQUcsTUFBTSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0cyBmcm9tICd0eXBlc2NyaXB0JztcbmltcG9ydCB7IHJlcGVhdCwgbWVyZ2UgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgVGVzdEZpbGVQYXJzZXJCYXNlIH0gZnJvbSAnLi4vLi4vdGVzdC1maWxlLXBhcnNlci1iYXNlJztcbmltcG9ydCBUeXBlc2NyaXB0Q29uZmlndXJhdGlvbiBmcm9tICcuLi8uLi8uLi8uLi9jb25maWd1cmF0aW9uL3R5cGVzY3JpcHQtY29uZmlndXJhdGlvbic7XG5cbmZ1bmN0aW9uIHJlcGxhY2VDb21tZW50cyAoY29kZSkge1xuICAgIHJldHVybiBjb2RlLnJlcGxhY2UoL1xcL1xcKltcXHNcXFNdKj9cXCpcXC98KFteXFxcXDpdfF4pXFwvXFwvLiokL2dtLCBtYXRjaCA9PiB7XG4gICAgICAgIGNvbnN0IGxhc3RTeW1ib2wgPSBtYXRjaC5pbmRleE9mKCdcXG4nKSA+IC0xID8gJ1xcbicgOiAnICc7XG5cbiAgICAgICAgcmV0dXJuIHJlcGVhdCgnICcsIG1hdGNoLmxlbmd0aCArIGxhc3RTeW1ib2wpO1xuICAgIH0pO1xufVxuXG5jbGFzcyBUeXBlU2NyaXB0VGVzdEZpbGVQYXJzZXIgZXh0ZW5kcyBUZXN0RmlsZVBhcnNlckJhc2Uge1xuICAgIGNvbnN0cnVjdG9yICgpIHtcbiAgICAgICAgc3VwZXIodHMuU3ludGF4S2luZCk7XG4gICAgfVxuXG4gICAgZ2V0Q29tcHV0ZWROYW1lU3RyaW5nICh7IHBvcywgZW5kIH0pIHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGVQb3MgPSB0aGlzLmdldExvY2F0aW9uQnlPZmZzZXRzKHBvcywgZW5kKTtcblxuICAgICAgICByZXR1cm4gVGVzdEZpbGVQYXJzZXJCYXNlLmZvcm1hdENvbXB1dGVkTmFtZSh0ZW1wbGF0ZVBvcy5sb2Muc3RhcnQubGluZSk7XG4gICAgfVxuXG4gICAgZ2V0VG9rZW5UeXBlICh0b2tlbikge1xuICAgICAgICByZXR1cm4gdG9rZW4ua2luZDtcbiAgICB9XG5cbiAgICBnZXRDYWxsZWVUb2tlbiAodG9rZW4pIHtcbiAgICAgICAgcmV0dXJuIHRva2VuLmV4cHJlc3Npb247XG4gICAgfVxuXG4gICAgZ2V0TWVtYmVyRm5OYW1lICh0b2tlbikge1xuICAgICAgICByZXR1cm4gdG9rZW4uZXhwcmVzc2lvbi5uYW1lLnRleHQ7XG4gICAgfVxuXG4gICAgZ2V0S2V5VmFsdWUgKHByb3ApIHtcbiAgICAgICAgY29uc3QgeyBuYW1lLCBpbml0aWFsaXplciB9ID0gcHJvcDtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAga2V5OiAgIG5hbWUudGV4dCxcbiAgICAgICAgICAgIHZhbHVlOiB0aGlzLmdldFN0cmluZ1ZhbHVlKGluaXRpYWxpemVyKSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBnZXRGaXhlZFN0YXJ0T2Zmc2V0IChzdGFydCkge1xuICAgICAgICBsZXQgZml4ZWRTdGFydE9mZnNldCA9IHN0YXJ0O1xuXG4gICAgICAgIHdoaWxlICgvXFxzLy50ZXN0KHRoaXMuY29kZVdpdGhvdXRDb21tZW50c1tmaXhlZFN0YXJ0T2Zmc2V0XSkpXG4gICAgICAgICAgICArK2ZpeGVkU3RhcnRPZmZzZXQ7XG5cbiAgICAgICAgcmV0dXJuIGZpeGVkU3RhcnRPZmZzZXQ7XG4gICAgfVxuXG4gICAgZ2V0TG9jYXRpb25CeU9mZnNldHMgKHN0YXJ0LCBlbmQpIHtcbiAgICAgICAgY29uc3QgZml4ZWRTdGFydCA9IHRoaXMuZ2V0Rml4ZWRTdGFydE9mZnNldChzdGFydCk7XG4gICAgICAgIGNvbnN0IGNvZGVBcnIgICAgPSB0aGlzLmNvZGVBcnI7XG4gICAgICAgIGNvbnN0IGxvYyAgICAgICAgPSB7IHN0YXJ0OiBudWxsLCBlbmQ6IG51bGwgfTtcblxuICAgICAgICBsZXQgbGluZSAgICAgPSBjb2RlQXJyWzBdO1xuICAgICAgICBsZXQgc3RhcnRUbXAgPSBmaXhlZFN0YXJ0O1xuICAgICAgICBsZXQgZW5kVG1wICAgPSBlbmQ7XG5cbiAgICAgICAgZm9yIChsZXQgbGluZU51bWJlciA9IDE7IGxpbmVOdW1iZXIgPD0gY29kZUFyci5sZW5ndGg7ICsrbGluZU51bWJlciwgbGluZSA9IGNvZGVBcnJbbGluZU51bWJlciAtIDFdKSB7XG4gICAgICAgICAgICBzdGFydFRtcCAtPSBsaW5lLmxlbmd0aCArIDE7XG4gICAgICAgICAgICBlbmRUbXAgLT0gbGluZS5sZW5ndGggKyAxO1xuXG4gICAgICAgICAgICBpZiAoc3RhcnRUbXAgPCAwICYmICFsb2Muc3RhcnQpXG4gICAgICAgICAgICAgICAgbG9jLnN0YXJ0ID0geyBsaW5lOiBsaW5lTnVtYmVyLCBjb2x1bW46IGxpbmUubGVuZ3RoICsgc3RhcnRUbXAgKyAxIH07XG5cbiAgICAgICAgICAgIGlmIChlbmRUbXAgPD0gMCB8fCBsaW5lTnVtYmVyID09PSBjb2RlQXJyLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgICAgICBsb2MuZW5kID0geyBsaW5lOiBsaW5lTnVtYmVyLCBjb2x1bW46IGxpbmUubGVuZ3RoICsgZW5kVG1wICsgMSB9O1xuXG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4geyBsb2MsIHN0YXJ0OiBmaXhlZFN0YXJ0LCBlbmQgfTtcbiAgICB9XG5cbiAgICBnZXRSVmFsdWUgKHRva2VuKSB7XG4gICAgICAgIHJldHVybiB0b2tlbi5kZWNsYXJhdGlvbkxpc3QuZGVjbGFyYXRpb25zWzBdLmluaXRpYWxpemVyO1xuICAgIH1cblxuICAgIGdldFN0cmluZ1ZhbHVlICh0b2tlbikge1xuICAgICAgICBjb25zdCBzdHJpbmdUeXBlcyA9IFt0aGlzLnRva2VuVHlwZS5TdHJpbmdMaXRlcmFsLCB0aGlzLnRva2VuVHlwZS5UZW1wbGF0ZUV4cHJlc3Npb25dO1xuXG4gICAgICAgIGlmIChzdHJpbmdUeXBlcy5pbmRleE9mKHRva2VuLmtpbmQpID4gLTEgfHwgdG9rZW4udGV4dCAmJiB0b2tlbi5raW5kICE9PSB0aGlzLnRva2VuVHlwZS5OdW1lcmljTGl0ZXJhbClcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdEZuQXJnKHRva2VuKTtcblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBpc0FzeW5jRm4gKHRva2VuKSB7XG4gICAgICAgIGNvbnN0IGlzR2VuZXJhdG9yRm4gPSAhIXRva2VuLmFzdGVyaXNrVG9rZW47XG4gICAgICAgIGNvbnN0IGlzQXN5bmNGbiAgICAgPSB0b2tlbi5tb2RpZmllcnMgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuLm1vZGlmaWVycy5zb21lKG1vZGlmaWVyID0+IG1vZGlmaWVyLmtpbmQgPT09IHRoaXMudG9rZW5UeXBlLkFzeW5jS2V5d29yZCk7XG5cbiAgICAgICAgcmV0dXJuIGlzR2VuZXJhdG9yRm4gfHwgaXNBc3luY0ZuO1xuICAgIH1cblxuICAgIGdldEZ1bmN0aW9uQm9keSAodG9rZW4pIHtcbiAgICAgICAgcmV0dXJuIHRva2VuLmJvZHkuc3RhdGVtZW50cztcbiAgICB9XG5cbiAgICBmb3JtYXRGbkRhdGEgKG5hbWUsIHZhbHVlLCB0b2tlbiwgbWV0YSA9IFt7fV0pIHtcbiAgICAgICAgY29uc3QgbG9jID0gdGhpcy5nZXRMb2NhdGlvbkJ5T2Zmc2V0cyh0b2tlbi5wb3MsIHRva2VuLmVuZCk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGZuTmFtZTogICAgbmFtZSxcbiAgICAgICAgICAgIHZhbHVlOiAgICAgdmFsdWUsXG4gICAgICAgICAgICBsb2M6ICAgICAgIGxvYy5sb2MsXG4gICAgICAgICAgICBzdGFydDogICAgIGxvYy5zdGFydCxcbiAgICAgICAgICAgIGVuZDogICAgICAgbG9jLmVuZCxcbiAgICAgICAgICAgIG1ldGE6ICAgICAgbWVyZ2Uoe30sIC4uLm1ldGEpLFxuICAgICAgICAgICAgaXNTa2lwcGVkOiBUZXN0RmlsZVBhcnNlckJhc2UuaXNTa2lwcGVkKHRva2VuKSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBhbmFseXplTWVtYmVyRXhwICh0b2tlbikge1xuICAgICAgICBsZXQgZXhwICAgICAgICAgPSB0b2tlbjtcbiAgICAgICAgY29uc3QgdG9rZW5UeXBlID0gdGhpcy50b2tlblR5cGU7XG4gICAgICAgIGNvbnN0IGNhbGxTdGFjayA9IFtleHBdO1xuXG4gICAgICAgIHdoaWxlIChleHAua2luZCAhPT0gdGhpcy50b2tlblR5cGUuSWRlbnRpZmllcikge1xuICAgICAgICAgICAgZXhwID0gZXhwLmV4cHJlc3Npb24gfHwgZXhwLnRhZztcblxuICAgICAgICAgICAgY2FsbFN0YWNrLnB1c2goZXhwKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG1ldGEgPSB0aGlzLmdldE1ldGFJbmZvKGNhbGxTdGFjay5zbGljZSgpKTtcblxuICAgICAgICBpZiAoZXhwICYmIHRoaXMuaXNBcGlGbihleHAudGV4dCkpIHtcbiAgICAgICAgICAgIGxldCBwYXJlbnRFeHAgPSBjYWxsU3RhY2sucG9wKCk7XG5cbiAgICAgICAgICAgIHdoaWxlIChwYXJlbnRFeHApIHtcbiAgICAgICAgICAgICAgICBpZiAocGFyZW50RXhwLmtpbmQgPT09IHRva2VuVHlwZS5DYWxsRXhwcmVzc2lvbiAmJiBwYXJlbnRFeHAuZXhwcmVzc2lvbikge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjYWxsZWVUeXBlICAgICA9IHBhcmVudEV4cC5leHByZXNzaW9uLmtpbmQ7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbGxlZU1lbWJlckZuID0gY2FsbGVlVHlwZSA9PT0gdG9rZW5UeXBlLlByb3BlcnR5QWNjZXNzRXhwcmVzc2lvbiAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEV4cC5leHByZXNzaW9uLm5hbWUudGV4dDtcblxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGVja0V4cERlZmluZVRhcmdldE5hbWUoY2FsbGVlVHlwZSwgY2FsbGVlTWVtYmVyRm4pKVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0Rm5EYXRhKGV4cC50ZXh0LCB0aGlzLmZvcm1hdEZuQXJnKHBhcmVudEV4cC5hcmd1bWVudHNbMF0pLCB0b2tlbiwgbWV0YSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHBhcmVudEV4cC5raW5kID09PSB0b2tlblR5cGUuVGFnZ2VkVGVtcGxhdGVFeHByZXNzaW9uICYmIHBhcmVudEV4cC50YWcpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFnVHlwZSAgICAgPSBwYXJlbnRFeHAudGFnLmtpbmQ7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhZ01lbWJlckZuID0gdGFnVHlwZSA9PT0gdG9rZW5UeXBlLlByb3BlcnR5QWNjZXNzRXhwcmVzc2lvbiAmJiBwYXJlbnRFeHAudGFnLm5hbWUudGV4dDtcblxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGVja0V4cERlZmluZVRhcmdldE5hbWUodGFnVHlwZSwgdGFnTWVtYmVyRm4pKVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0Rm5EYXRhKGV4cC50ZXh0LCB0aGlzLmZvcm1hdEZuQXJnKHBhcmVudEV4cCksIHRva2VuLCBtZXRhKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBwYXJlbnRFeHAgPSBjYWxsU3RhY2sucG9wKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBmb3JtYXRGbkFyZyAoYXJnKSB7XG4gICAgICAgIGlmIChhcmcudGVtcGxhdGVTcGFucylcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldENvbXB1dGVkTmFtZVN0cmluZyh7IHBvczogYXJnLnBvcywgZW5kOiBhcmcuZW5kIH0pO1xuXG4gICAgICAgIGlmIChhcmcuaGVhZClcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldENvbXB1dGVkTmFtZVN0cmluZyh7IHBvczogYXJnLnRlbXBsYXRlLnBvcywgZW5kOiBhcmcudGVtcGxhdGUuZW5kIH0pO1xuXG4gICAgICAgIGlmIChhcmcudGVtcGxhdGUpXG4gICAgICAgICAgICByZXR1cm4gYXJnLnRlbXBsYXRlLnRleHQgfHwgdGhpcy5nZXRDb21wdXRlZE5hbWVTdHJpbmcoeyBwb3M6IGFyZy50ZW1wbGF0ZS5wb3MsIGVuZDogYXJnLnRlbXBsYXRlLmVuZCB9KTtcblxuICAgICAgICBpZiAoYXJnLmtpbmQgPT09IHRoaXMudG9rZW5UeXBlLklkZW50aWZpZXIpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDb21wdXRlZE5hbWVTdHJpbmcoeyBwb3M6IGFyZy5wb3MsIGVuZDogYXJnLmVuZCB9KTtcblxuICAgICAgICBpZiAoYXJnLnRleHQgJiYgYXJnLmtpbmQgIT09IHRoaXMudG9rZW5UeXBlLk51bWVyaWNMaXRlcmFsKVxuICAgICAgICAgICAgcmV0dXJuIGFyZy50ZXh0O1xuXG4gICAgICAgIGlmIChhcmcua2luZCA9PT0gdGhpcy50b2tlblR5cGUuVHlwZUFzc2VydGlvbkV4cHJlc3Npb24pXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXRGbkFyZyhhcmcuZXhwcmVzc2lvbik7XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgZ2V0Rm5DYWxsICh0b2tlbikge1xuICAgICAgICBpZiAodGhpcy5pc0FwaUZuKHRva2VuLmV4cHJlc3Npb24udGV4dCkpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXRGbkRhdGEodG9rZW4uZXhwcmVzc2lvbi50ZXh0LCB0aGlzLmZvcm1hdEZuQXJnKHRva2VuLmFyZ3VtZW50c1swXSksIHRva2VuKTtcblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBnZXRUYWdnZWRUZW1wbGF0ZUV4cCAodG9rZW4pIHtcbiAgICAgICAgaWYgKHRoaXMuaXNBcGlGbih0b2tlbi50YWcudGV4dCkpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXRGbkRhdGEodG9rZW4udGFnLnRleHQsIHRoaXMuZm9ybWF0Rm5BcmcodG9rZW4pLCB0b2tlbik7XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgYW5hbHl6ZUZuQ2FsbCAodG9rZW4pIHtcbiAgICAgICAgY29uc3QgdG9rZW5UeXBlID0gdGhpcy50b2tlblR5cGU7XG5cbiAgICAgICAgaWYgKHRva2VuLmtpbmQgPT09IHRva2VuVHlwZS5Qcm9wZXJ0eUFjY2Vzc0V4cHJlc3Npb24pXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hbmFseXplTWVtYmVyRXhwKHRva2VuKTtcblxuICAgICAgICBpZiAodG9rZW4ua2luZCA9PT0gdG9rZW5UeXBlLkNhbGxFeHByZXNzaW9uKSB7XG4gICAgICAgICAgICBjb25zdCBleHBLaW5kID0gdG9rZW4uZXhwcmVzc2lvbi5raW5kO1xuXG4gICAgICAgICAgICBpZiAoZXhwS2luZCA9PT0gdG9rZW5UeXBlLlByb3BlcnR5QWNjZXNzRXhwcmVzc2lvbiB8fCBleHBLaW5kID09PSB0b2tlblR5cGUuQ2FsbEV4cHJlc3Npb24pXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYW5hbHl6ZU1lbWJlckV4cCh0b2tlbik7XG5cbiAgICAgICAgICAgIGlmIChleHBLaW5kID09PSB0b2tlblR5cGUuUGFyZW50aGVzaXplZEV4cHJlc3Npb24pXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYW5hbHl6ZUZuQ2FsbCh0b2tlbi5leHByZXNzaW9uLmV4cHJlc3Npb24pO1xuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRGbkNhbGwodG9rZW4pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRva2VuLmtpbmQgPT09IHRva2VuVHlwZS5GdW5jdGlvbkV4cHJlc3Npb24gfHwgdG9rZW4ua2luZCA9PT0gdG9rZW5UeXBlLkFycm93RnVuY3Rpb24pXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb2xsZWN0VGVzdENhZmVDYWxscyh0aGlzLmdldEZ1bmN0aW9uQm9keSh0b2tlbikpO1xuXG4gICAgICAgIGlmICh0b2tlbi5raW5kID09PSB0b2tlblR5cGUuVGFnZ2VkVGVtcGxhdGVFeHByZXNzaW9uKSB7XG4gICAgICAgICAgICBpZiAodG9rZW4udGFnLmtpbmQgPT09IHRva2VuVHlwZS5Qcm9wZXJ0eUFjY2Vzc0V4cHJlc3Npb24gfHwgdG9rZW4udGFnLmtpbmQgPT09IHRva2VuVHlwZS5DYWxsRXhwcmVzc2lvbilcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hbmFseXplTWVtYmVyRXhwKHRva2VuKTtcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VGFnZ2VkVGVtcGxhdGVFeHAodG9rZW4pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcGFyc2UgKGNvZGUpIHtcbiAgICAgICAgLy9OT1RFOiBUeXBlU2NyaXB0IGNhbGN1bGF0ZXMgc3RhcnQgcG9zaXRpb24gb2YgYSB0b2tlbiBpbmNvcnJlY3RseVxuICAgICAgICAvL0l0IGRvZXNuJ3QgY29uc2lkZXIgc3BhY2VzIGFuZCBjb21tZW50cyBiZXR3ZWVuIHRoZSBsYXN0IHRva2VuIGFuZCB0aGUgY3VycmVudCB0b2tlbi5cbiAgICAgICAgLy9TbyB3ZSByZXBsYWNlIGNvbW1lbnRzIHdpdGggc3BhY2Ugc3ltYm9scyB0byBjYWxjdWxhdGUgZml4ZWQgcG9zaXRpb24uXG4gICAgICAgIC8vV2UganVzdCBpbmNyZW1lbnQgcG9zaXRpb24gdW50aWwgd2UgbWVldCBub24gd2hpdGVzcGFjZSBjaGFyYWN0ZXJzXG4gICAgICAgIHRoaXMuY29kZUFyciAgICAgICAgICAgICA9IGNvZGUuc3BsaXQoJ1xcbicpO1xuICAgICAgICB0aGlzLmNvZGVXaXRob3V0Q29tbWVudHMgPSByZXBsYWNlQ29tbWVudHMoY29kZSk7XG5cbiAgICAgICAgY29uc3QgdHNDb25maWcgICA9IG5ldyBUeXBlc2NyaXB0Q29uZmlndXJhdGlvbigpO1xuICAgICAgICBjb25zdCBzb3VyY2VGaWxlID0gdHMuY3JlYXRlU291cmNlRmlsZSgnJywgY29kZSwgdHNDb25maWcuZ2V0T3B0aW9ucygpLCB0cnVlKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5hbmFseXplKHNvdXJjZUZpbGUuc3RhdGVtZW50cyk7XG4gICAgfVxufVxuXG5jb25zdCBwYXJzZXIgPSBuZXcgVHlwZVNjcmlwdFRlc3RGaWxlUGFyc2VyKCk7XG5cbmV4cG9ydCBjb25zdCBnZXRUeXBlU2NyaXB0VGVzdExpc3QgICAgICAgICA9IHBhcnNlci5nZXRUZXN0TGlzdC5iaW5kKHBhcnNlcik7XG5leHBvcnQgY29uc3QgZ2V0VHlwZVNjcmlwdFRlc3RMaXN0RnJvbUNvZGUgPSBwYXJzZXIuZ2V0VGVzdExpc3RGcm9tQ29kZS5iaW5kKHBhcnNlcik7XG4iXX0=