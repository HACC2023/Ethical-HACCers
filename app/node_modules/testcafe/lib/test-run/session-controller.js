"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = __importDefault(require("path"));
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const _1 = __importDefault(require("./"));
const ACTIVE_SESSIONS_MAP = {};
const UPLOADS_DIR_NAME = '_uploads_';
// NOTE: Native Automation cookie implementation doesn't require client-server communication.
// This stub was created to reduce conditional logic in connected classes.
class NativeAutomationCookieStub {
    getClientString() {
        return '';
    }
    takePendingSyncCookies() {
        return [];
    }
}
class SessionController extends testcafe_hammerhead_1.Session {
    constructor(uploadRoots, options) {
        super(uploadRoots, options);
        this.currentTestRun = null;
    }
    // Hammerhead payload
    async getPayloadScript() {
        return this.currentTestRun.getPayloadScript();
    }
    async getIframePayloadScript() {
        return this.currentTestRun.getIframePayloadScript();
    }
    // Hammerhead handlers
    handleServiceMessage(msg, serverInfo) {
        if (this.currentTestRun[msg.cmd])
            return super.handleServiceMessage.call(this.currentTestRun, msg, serverInfo);
        return super.handleServiceMessage(msg, serverInfo);
    }
    getAuthCredentials() {
        return this.currentTestRun.getAuthCredentials();
    }
    handleFileDownload() {
        return this.currentTestRun.handleFileDownload();
    }
    handleAttachment(data) {
        return this.currentTestRun.handleAttachment(data);
    }
    handlePageError(ctx, err) {
        return this.currentTestRun.handlePageError(ctx, err);
    }
    createCookies() {
        return this.options.nativeAutomation ? new NativeAutomationCookieStub() : super.createCookies();
    }
    // API
    static getSession(testRun) {
        let sessionInfo = ACTIVE_SESSIONS_MAP[testRun.browserConnection.id];
        if (!sessionInfo || !testRun.disablePageReloads) {
            if (sessionInfo && sessionInfo.url)
                SessionController.closeSession(testRun);
            let session = null;
            if (testRun.test.isLegacy)
                session = testRun;
            else {
                const fixtureDir = path_1.default.dirname(testRun.test.fixture.path);
                const uploadRoots = [
                    path_1.default.resolve(UPLOADS_DIR_NAME),
                    path_1.default.resolve(fixtureDir, UPLOADS_DIR_NAME),
                    fixtureDir,
                ];
                const options = {
                    disablePageCaching: testRun.disablePageCaching,
                    allowMultipleWindows: _1.default.isMultipleWindowsAllowed(testRun),
                    requestTimeout: testRun.requestTimeout,
                    nativeAutomation: testRun.isNativeAutomation,
                };
                if (options.allowMultipleWindows)
                    options.windowId = testRun.browserConnection.activeWindowId;
                session = new SessionController(uploadRoots, options);
                session.currentTestRun = testRun;
            }
            sessionInfo = {
                session: session,
                proxy: null,
                url: null,
            };
            ACTIVE_SESSIONS_MAP[testRun.browserConnection.id] = sessionInfo;
        }
        else if (!testRun.test.isLegacy)
            sessionInfo.session.currentTestRun = testRun;
        return sessionInfo.session;
    }
    static getSessionUrl(testRun, proxy) {
        let sessionInfo = ACTIVE_SESSIONS_MAP[testRun.browserConnection.id];
        if (!sessionInfo || testRun.test.isLegacy) {
            SessionController.getSession(testRun);
            sessionInfo = ACTIVE_SESSIONS_MAP[testRun.browserConnection.id];
        }
        if (!sessionInfo.url) {
            const pageUrl = testRun.test.pageUrl;
            const externalProxyHost = testRun.opts.proxy;
            let externalProxySettings = null;
            if (externalProxyHost) {
                externalProxySettings = {
                    url: externalProxyHost,
                    bypassRules: testRun.opts.proxyBypass,
                };
            }
            sessionInfo.proxy = proxy;
            sessionInfo.url = proxy.openSession(pageUrl, sessionInfo.session, externalProxySettings);
        }
        return sessionInfo.url;
    }
    static closeSession(testRun) {
        const sessionInfo = ACTIVE_SESSIONS_MAP[testRun.browserConnection.id];
        if (!sessionInfo || !sessionInfo.url || !sessionInfo.proxy)
            return;
        sessionInfo.proxy.closeSession(sessionInfo.session);
        delete ACTIVE_SESSIONS_MAP[testRun.browserConnection.id];
    }
}
exports.default = SessionController;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Vzc2lvbi1jb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3Rlc3QtcnVuL3Nlc3Npb24tY29udHJvbGxlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLGdEQUF3QjtBQUN4Qiw2REFBOEM7QUFDOUMsMENBQXlCO0FBR3pCLE1BQU0sbUJBQW1CLEdBQUcsRUFBRSxDQUFDO0FBQy9CLE1BQU0sZ0JBQWdCLEdBQUcsV0FBVyxDQUFDO0FBRXJDLDZGQUE2RjtBQUM3RiwwRUFBMEU7QUFDMUUsTUFBTSwwQkFBMEI7SUFDNUIsZUFBZTtRQUNYLE9BQU8sRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVELHNCQUFzQjtRQUNsQixPQUFPLEVBQUUsQ0FBQztJQUNkLENBQUM7Q0FDSjtBQUVELE1BQXFCLGlCQUFrQixTQUFRLDZCQUFPO0lBQ2xELFlBQWEsV0FBVyxFQUFFLE9BQU87UUFDN0IsS0FBSyxDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUU1QixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQztJQUMvQixDQUFDO0lBRUQscUJBQXFCO0lBQ3JCLEtBQUssQ0FBQyxnQkFBZ0I7UUFDbEIsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDbEQsQ0FBQztJQUVELEtBQUssQ0FBQyxzQkFBc0I7UUFDeEIsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLHNCQUFzQixFQUFFLENBQUM7SUFDeEQsQ0FBQztJQUdELHNCQUFzQjtJQUN0QixvQkFBb0IsQ0FBRSxHQUFHLEVBQUUsVUFBVTtRQUNqQyxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztZQUM1QixPQUFPLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxHQUFHLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFFakYsT0FBTyxLQUFLLENB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Q0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXBELE9BQU8sbUJBQW1CLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzdELENBQUM7Q0FDSjtBQXJJRCxvQ0FxSUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IFNlc3Npb24gfSBmcm9tICd0ZXN0Y2FmZS1oYW1tZXJoZWFkJztcbmltcG9ydCBUZXN0UnVuIGZyb20gJy4vJztcblxuXG5jb25zdCBBQ1RJVkVfU0VTU0lPTlNfTUFQID0ge307XG5jb25zdCBVUExPQURTX0RJUl9OQU1FID0gJ191cGxvYWRzXyc7XG5cbi8vIE5PVEU6IE5hdGl2ZSBBdXRvbWF0aW9uIGNvb2tpZSBpbXBsZW1lbnRhdGlvbiBkb2Vzbid0IHJlcXVpcmUgY2xpZW50LXNlcnZlciBjb21tdW5pY2F0aW9uLlxuLy8gVGhpcyBzdHViIHdhcyBjcmVhdGVkIHRvIHJlZHVjZSBjb25kaXRpb25hbCBsb2dpYyBpbiBjb25uZWN0ZWQgY2xhc3Nlcy5cbmNsYXNzIE5hdGl2ZUF1dG9tYXRpb25Db29raWVTdHViIHtcbiAgICBnZXRDbGllbnRTdHJpbmcgKCkge1xuICAgICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgdGFrZVBlbmRpbmdTeW5jQ29va2llcyAoKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNlc3Npb25Db250cm9sbGVyIGV4dGVuZHMgU2Vzc2lvbiB7XG4gICAgY29uc3RydWN0b3IgKHVwbG9hZFJvb3RzLCBvcHRpb25zKSB7XG4gICAgICAgIHN1cGVyKHVwbG9hZFJvb3RzLCBvcHRpb25zKTtcblxuICAgICAgICB0aGlzLmN1cnJlbnRUZXN0UnVuID0gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBIYW1tZXJoZWFkIHBheWxvYWRcbiAgICBhc3luYyBnZXRQYXlsb2FkU2NyaXB0ICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFRlc3RSdW4uZ2V0UGF5bG9hZFNjcmlwdCgpO1xuICAgIH1cblxuICAgIGFzeW5jIGdldElmcmFtZVBheWxvYWRTY3JpcHQgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50VGVzdFJ1bi5nZXRJZnJhbWVQYXlsb2FkU2NyaXB0KCk7XG4gICAgfVxuXG5cbiAgICAvLyBIYW1tZXJoZWFkIGhhbmRsZXJzXG4gICAgaGFuZGxlU2VydmljZU1lc3NhZ2UgKG1zZywgc2VydmVySW5mbykge1xuICAgICAgICBpZiAodGhpcy5jdXJyZW50VGVzdFJ1blttc2cuY21kXSlcbiAgICAgICAgICAgIHJldHVybiBzdXBlci5oYW5kbGVTZXJ2aWNlTWVzc2FnZS5jYWxsKHRoaXMuY3VycmVudFRlc3RSdW4sIG1zZywgc2VydmVySW5mbyk7XG5cbiAgICAgICAgcmV0dXJuIHN1cGVyLmhhbmRsZVNlcnZpY2VNZXNzYWdlKG1zZywgc2VydmVySW5mbyk7XG4gICAgfVxuXG4gICAgZ2V0QXV0aENyZWRlbnRpYWxzICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFRlc3RSdW4uZ2V0QXV0aENyZWRlbnRpYWxzKCk7XG4gICAgfVxuXG4gICAgaGFuZGxlRmlsZURvd25sb2FkICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFRlc3RSdW4uaGFuZGxlRmlsZURvd25sb2FkKCk7XG4gICAgfVxuXG4gICAgaGFuZGxlQXR0YWNobWVudCAoZGF0YSkge1xuICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50VGVzdFJ1bi5oYW5kbGVBdHRhY2htZW50KGRhdGEpO1xuICAgIH1cblxuICAgIGhhbmRsZVBhZ2VFcnJvciAoY3R4LCBlcnIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFRlc3RSdW4uaGFuZGxlUGFnZUVycm9yKGN0eCwgZXJyKTtcbiAgICB9XG5cbiAgICBjcmVhdGVDb29raWVzICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5uYXRpdmVBdXRvbWF0aW9uID8gbmV3IE5hdGl2ZUF1dG9tYXRpb25Db29raWVTdHViKCkgOiBzdXBlci5jcmVhdGVDb29raWVzKCk7XG4gICAgfVxuXG4gICAgLy8gQVBJXG4gICAgc3RhdGljIGdldFNlc3Npb24gKHRlc3RSdW4pIHtcbiAgICAgICAgbGV0IHNlc3Npb25JbmZvID0gQUNUSVZFX1NFU1NJT05TX01BUFt0ZXN0UnVuLmJyb3dzZXJDb25uZWN0aW9uLmlkXTtcblxuICAgICAgICBpZiAoIXNlc3Npb25JbmZvIHx8ICF0ZXN0UnVuLmRpc2FibGVQYWdlUmVsb2Fkcykge1xuICAgICAgICAgICAgaWYgKHNlc3Npb25JbmZvICYmIHNlc3Npb25JbmZvLnVybClcbiAgICAgICAgICAgICAgICBTZXNzaW9uQ29udHJvbGxlci5jbG9zZVNlc3Npb24odGVzdFJ1bik7XG5cbiAgICAgICAgICAgIGxldCBzZXNzaW9uID0gbnVsbDtcblxuICAgICAgICAgICAgaWYgKHRlc3RSdW4udGVzdC5pc0xlZ2FjeSlcbiAgICAgICAgICAgICAgICBzZXNzaW9uID0gdGVzdFJ1bjtcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IGZpeHR1cmVEaXIgPSBwYXRoLmRpcm5hbWUodGVzdFJ1bi50ZXN0LmZpeHR1cmUucGF0aCk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCB1cGxvYWRSb290cyA9IFtcbiAgICAgICAgICAgICAgICAgICAgcGF0aC5yZXNvbHZlKFVQTE9BRFNfRElSX05BTUUpLFxuICAgICAgICAgICAgICAgICAgICBwYXRoLnJlc29sdmUoZml4dHVyZURpciwgVVBMT0FEU19ESVJfTkFNRSksXG4gICAgICAgICAgICAgICAgICAgIGZpeHR1cmVEaXIsXG4gICAgICAgICAgICAgICAgXTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgICAgIGRpc2FibGVQYWdlQ2FjaGluZzogICB0ZXN0UnVuLmRpc2FibGVQYWdlQ2FjaGluZyxcbiAgICAgICAgICAgICAgICAgICAgYWxsb3dNdWx0aXBsZVdpbmRvd3M6IFRlc3RSdW4uaXNNdWx0aXBsZVdpbmRvd3NBbGxvd2VkKHRlc3RSdW4pLFxuICAgICAgICAgICAgICAgICAgICByZXF1ZXN0VGltZW91dDogICAgICAgdGVzdFJ1bi5yZXF1ZXN0VGltZW91dCxcbiAgICAgICAgICAgICAgICAgICAgbmF0aXZlQXV0b21hdGlvbjogICAgIHRlc3RSdW4uaXNOYXRpdmVBdXRvbWF0aW9uLFxuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5hbGxvd011bHRpcGxlV2luZG93cylcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy53aW5kb3dJZCA9IHRlc3RSdW4uYnJvd3NlckNvbm5lY3Rpb24uYWN0aXZlV2luZG93SWQ7XG5cbiAgICAgICAgICAgICAgICBzZXNzaW9uID0gbmV3IFNlc3Npb25Db250cm9sbGVyKHVwbG9hZFJvb3RzLCBvcHRpb25zKTtcblxuICAgICAgICAgICAgICAgIHNlc3Npb24uY3VycmVudFRlc3RSdW4gPSB0ZXN0UnVuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZXNzaW9uSW5mbyA9IHtcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBzZXNzaW9uLFxuICAgICAgICAgICAgICAgIHByb3h5OiAgIG51bGwsXG4gICAgICAgICAgICAgICAgdXJsOiAgICAgbnVsbCxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIEFDVElWRV9TRVNTSU9OU19NQVBbdGVzdFJ1bi5icm93c2VyQ29ubmVjdGlvbi5pZF0gPSBzZXNzaW9uSW5mbztcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmICghdGVzdFJ1bi50ZXN0LmlzTGVnYWN5KVxuICAgICAgICAgICAgc2Vzc2lvbkluZm8uc2Vzc2lvbi5jdXJyZW50VGVzdFJ1biA9IHRlc3RSdW47XG5cbiAgICAgICAgcmV0dXJuIHNlc3Npb25JbmZvLnNlc3Npb247XG4gICAgfVxuXG4gICAgc3RhdGljIGdldFNlc3Npb25VcmwgKHRlc3RSdW4sIHByb3h5KSB7XG4gICAgICAgIGxldCBzZXNzaW9uSW5mbyA9IEFDVElWRV9TRVNTSU9OU19NQVBbdGVzdFJ1bi5icm93c2VyQ29ubmVjdGlvbi5pZF07XG5cbiAgICAgICAgaWYgKCFzZXNzaW9uSW5mbyB8fCB0ZXN0UnVuLnRlc3QuaXNMZWdhY3kpIHtcbiAgICAgICAgICAgIFNlc3Npb25Db250cm9sbGVyLmdldFNlc3Npb24odGVzdFJ1bik7XG5cbiAgICAgICAgICAgIHNlc3Npb25JbmZvID0gQUNUSVZFX1NFU1NJT05TX01BUFt0ZXN0UnVuLmJyb3dzZXJDb25uZWN0aW9uLmlkXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghc2Vzc2lvbkluZm8udXJsKSB7XG4gICAgICAgICAgICBjb25zdCBwYWdlVXJsICAgICAgICAgICAgID0gdGVzdFJ1bi50ZXN0LnBhZ2VVcmw7XG4gICAgICAgICAgICBjb25zdCBleHRlcm5hbFByb3h5SG9zdCAgID0gdGVzdFJ1bi5vcHRzLnByb3h5O1xuICAgICAgICAgICAgbGV0IGV4dGVybmFsUHJveHlTZXR0aW5ncyA9IG51bGw7XG5cbiAgICAgICAgICAgIGlmIChleHRlcm5hbFByb3h5SG9zdCkge1xuICAgICAgICAgICAgICAgIGV4dGVybmFsUHJveHlTZXR0aW5ncyA9IHtcbiAgICAgICAgICAgICAgICAgICAgdXJsOiAgICAgICAgIGV4dGVybmFsUHJveHlIb3N0LFxuICAgICAgICAgICAgICAgICAgICBieXBhc3NSdWxlczogdGVzdFJ1bi5vcHRzLnByb3h5QnlwYXNzLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHNlc3Npb25JbmZvLnByb3h5ID0gcHJveHk7XG4gICAgICAgICAgICBzZXNzaW9uSW5mby51cmwgICA9IHByb3h5Lm9wZW5TZXNzaW9uKHBhZ2VVcmwsIHNlc3Npb25JbmZvLnNlc3Npb24sIGV4dGVybmFsUHJveHlTZXR0aW5ncyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc2Vzc2lvbkluZm8udXJsO1xuICAgIH1cblxuICAgIHN0YXRpYyBjbG9zZVNlc3Npb24gKHRlc3RSdW4pIHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbkluZm8gPSBBQ1RJVkVfU0VTU0lPTlNfTUFQW3Rlc3RSdW4uYnJvd3NlckNvbm5lY3Rpb24uaWRdO1xuXG4gICAgICAgIGlmICghc2Vzc2lvbkluZm8gfHwgIXNlc3Npb25JbmZvLnVybCB8fCAhc2Vzc2lvbkluZm8ucHJveHkpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgc2Vzc2lvbkluZm8ucHJveHkuY2xvc2VTZXNzaW9uKHNlc3Npb25JbmZvLnNlc3Npb24pO1xuXG4gICAgICAgIGRlbGV0ZSBBQ1RJVkVfU0VTU0lPTlNfTUFQW3Rlc3RSdW4uYnJvd3NlckNvbm5lY3Rpb24uaWRdO1xuICAgIH1cbn1cblxuIl19