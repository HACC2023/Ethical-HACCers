"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const os_family_1 = __importDefault(require("os-family"));
const which_promise_1 = __importDefault(require("which-promise"));
const lodash_1 = require("lodash");
const fs_exists_promised_1 = __importDefault(require("../utils/fs-exists-promised"));
const exec_1 = require("../utils/exec");
const find_alias_1 = __importDefault(require("../utils/find-alias"));
const unquote_1 = __importDefault(require("../utils/unquote"));
const aliases_1 = __importDefault(require("../aliases"));
const MICROSOFT_EDGE_CLASS = 'Microsoft.MicrosoftEdge';
const MICROSOFT_EDGE_KEY_GLOB = `HKCU\\Software\\Classes\\ActivatableClasses\\Package\\${MICROSOFT_EDGE_CLASS}*`;
const BROWSER_COMMANDS_KEY_GLOB = root => `${root}\\Software\\Clients\\StartMenuInternet\\*\\shell\\open\\command`;
const MACOS_GET_BROWSER_LIST_COMMAND = 'ls "/Applications/" | grep -E "Chrome|Firefox|Opera|Safari|Chromium|Edge" | sed -E "s/ /032/"';
const LINE_WRAP = '\r\n';
const DOUBLE_LINE_WRAP = LINE_WRAP + LINE_WRAP;
const REGISTRY_BROWSER_PATH_PROPERTY = '(default)';
const REGISTRY_BROWSER_NAME_PROPERTY = 'PSPath';
const REGISTRY_PROPERTIES_RE = /^(\(default\)|PSPath)\s*:\s*(.+)$/;
const MAX_OUTPUT_WIDTH = 2 ** 31 - 1;
const POWERSHELL_PIPE_SYMBOL = '|';
const GET_REGISTRY_KEY_COMMAND = key => `Get-Item 'Registry::${key}'`;
const GET_BROWSER_PATH_PROPERTY_COMMAND = `Get-ItemProperty -Name '${REGISTRY_BROWSER_PATH_PROPERTY}'`;
const FORMAT_BROWSER_INFO_COMMAND = `Format-List -Property '${REGISTRY_BROWSER_PATH_PROPERTY}','${REGISTRY_BROWSER_NAME_PROPERTY}'`;
const LIMIT_OUTPUT_WIDTH_COMMAND = `Out-String -Width ${MAX_OUTPUT_WIDTH}`;
// NOTE: We have to use Write-Host for compatibility with PowerShell 2.0
const WRITE_HOST_COMMAND = 'Write-Host';
const GET_REGISTRY_BROWSER_PROPERTIES_COMMAND = key => [
    GET_REGISTRY_KEY_COMMAND(key),
    GET_BROWSER_PATH_PROPERTY_COMMAND,
    FORMAT_BROWSER_INFO_COMMAND,
    LIMIT_OUTPUT_WIDTH_COMMAND,
    WRITE_HOST_COMMAND
].join(POWERSHELL_PIPE_SYMBOL);
// Installation info cache
var installationsCache = null;
async function getRegistryKey(regKeyGlob) {
    return (0, exec_1.execPowershell)(GET_REGISTRY_KEY_COMMAND(regKeyGlob));
}
async function getRegistryBrowserProperties(regKeyGlob) {
    return (0, exec_1.execPowershell)(GET_REGISTRY_BROWSER_PROPERTIES_COMMAND(regKeyGlob));
}
// Find installations for different platforms
async function addInstallation(installations, key, instPath) {
    if (!await (0, fs_exists_promised_1.default)(instPath))
        return;
    const detectedAlias = (0, find_alias_1.default)(key);
    if (!detectedAlias)
        return;
    const { name, alias: { cmd, macOpenCmdTemplate, path } } = detectedAlias;
    installations[name] = { path: path || instPath, cmd, macOpenCmdTemplate };
}
async function detectMicrosoftEdgeLegacy() {
    const registryResult = await getRegistryKey(MICROSOFT_EDGE_KEY_GLOB);
    if (registryResult.stdout.includes(MICROSOFT_EDGE_CLASS))
        return aliases_1.default['edge-legacy'];
    return null;
}
async function searchInRegistry(registryRoot) {
    const installations = {};
    const registryResult = await getRegistryBrowserProperties(BROWSER_COMMANDS_KEY_GLOB(registryRoot));
    const data = registryResult.stdout
        .split(DOUBLE_LINE_WRAP)
        .map(block => block
        .split(LINE_WRAP)
        .map(line => line.match(REGISTRY_PROPERTIES_RE))
        .filter(match => !!match)
        .map(match => ({
        [match[1]]: (0, unquote_1.default)(match[2])
    })))
        .filter(block => block && block.length)
        .map(block => (0, lodash_1.merge)(...block));
    await Promise.all(data.map(record => addInstallation(installations, record[REGISTRY_BROWSER_NAME_PROPERTY], record[REGISTRY_BROWSER_PATH_PROPERTY])));
    return installations;
}
async function findWindowsBrowsers() {
    const machineRegisteredBrowsers = await searchInRegistry('HKEY_LOCAL_MACHINE');
    const userRegisteredBrowsers = await searchInRegistry('HKEY_CURRENT_USER');
    const installations = Object.assign(machineRegisteredBrowsers, userRegisteredBrowsers);
    const edgeLegacy = await detectMicrosoftEdgeLegacy();
    if (edgeLegacy)
        installations['edge-legacy'] = edgeLegacy;
    if (edgeLegacy && !installations['edge'])
        installations['edge'] = edgeLegacy;
    return installations;
}
async function findMacBrowsers() {
    var installations = {};
    // NOTE: replace the space symbol with code, because grep splits strings by space.
    var stdout = await (0, exec_1.exec)(MACOS_GET_BROWSER_LIST_COMMAND);
    await Promise.all(stdout
        .split('\n')
        .filter(fileName => !!fileName)
        .map(fileName => {
        // NOTE: restore space
        fileName = fileName.replace(/032/g, ' ');
        var name = fileName.replace(/.app$/, '');
        var path = `/Applications/${fileName}`;
        return addInstallation(installations, name, path);
    }));
    return installations;
}
async function findLinuxBrowsers() {
    var installations = {};
    var aliasCheckingPromises = Object
        .keys(aliases_1.default)
        .map(name => {
        var { linuxBinaries } = aliases_1.default[name];
        if (!linuxBinaries)
            return null;
        var detectionPromises = linuxBinaries
            .map(binary => {
            return (0, which_promise_1.default)(binary)
                .then(path => addInstallation(installations, name, path))
                .catch(() => {
                // NOTE: binary not found, just do nothing
                return;
            });
        });
        return Promise.all(detectionPromises);
    });
    await Promise.all(aliasCheckingPromises);
    return installations;
}
async function findBrowsers() {
    if (os_family_1.default.win)
        return await findWindowsBrowsers();
    if (os_family_1.default.mac)
        return await findMacBrowsers();
    if (os_family_1.default.linux)
        return await findLinuxBrowsers();
    return {};
}
// API
/** @typedef {Object} BrowserInfo
 * @description Object that contains information about the browser installed on the machine.
 * @property {string|undefined} path - The path to the executable file that starts the browser.
 *  Required on MacOS machines. On Windows machines, it is used when the winOpenCmdTemplate property is undefined.
 * @property {string} cmd - Additional command line parameters.
 * @property {string} macOpenCmdTemplate - A [Mustache template](https://github.com/janl/mustache.js#templates)
 *  that provides parameters for launching the browser on a MacOS machine.
 * @property {string|undefined} winOpenCmdTemplate - A [Mustache template](https://github.com/janl/mustache.js#templates)
 *  that provides parameters for launching the browser on a Windows machine.  If undefined, the path to the
 *  executable file specified by the path property is used.
 * @example
 *  {
 *       path: 'C:\\ProgramFiles\\...\\firefox.exe',
 *       cmd: '-new-window',
 *       macOpenCmdTemplate: 'open -a "{{{path}}}" {{{pageUrl}}} --args {{{cmd}}}'
 *  }
 */
/**
 * Returns the list of the {@link BrowserInfo} objects that contain information about the browsers installed on the machine.
 * @function
 * @async
 * @name getInstallations
 * @returns {Object.<string, BrowserInfo>} List of the {@link BrowserInfo} objects
 *   containing information about the browsers installed on the machine.
 * @example
 * {
 *   chrome: {
 *       path: 'C:\\ProgramFiles\\...\\chrome.exe',
 *       cmd: '--new-window',
 *       macOpenCmdTemplate: 'open -n -a "{{{path}}}" --args {{{pageUrl}}} {{{cmd}}}'
 *   },
 *
 *   firefox: {
 *       path: 'C:\\ProgramFiles\\...\\firefox.exe',
 *       cmd: '-new-window',
 *       macOpenCmdTemplate: 'open -a "{{{path}}}" {{{pageUrl}}} --args {{{cmd}}}'
 *   }
 * }
 */
async function default_1() {
    if (!installationsCache)
        installationsCache = await findBrowsers();
    return installationsCache;
}
exports.default = default_1;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWluc3RhbGxhdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXBpL2dldC1pbnN0YWxsYXRpb25zLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsMERBQTJCO0FBQzNCLGtFQUFrQztBQUNsQyxtQ0FBK0I7QUFDL0IscUZBQWlEO0FBQ2pELHdDQUFxRDtBQUNyRCxxRUFBNEM7QUFDNUMsK0RBQXVDO0FBQ3ZDLHlEQUFpQztBQUVqQyxNQUFNLG9CQUFvQixHQUFRLHlCQUF5QixDQUFDO0FBQzVELE1BQU0sdUJBQXVCLEdBQUsseURBQXlELG9CQUFvQixHQUFHLENBQUM7QUFDbkgsTUFBTSx5QkFBeUIsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxpRUFBaUUsQ0FBQztBQUVuSCxNQUFNLDhCQUE4QixHQUFHLCtGQUErRixDQUFDO0FBRXZJLE1BQU0sU0FBUyxHQUFVLE1BQU0sQ0FBQztBQUNoQyxNQUFNLGdCQUFnQixHQUFHLFNBQVMsR0FBRyxTQUFTLENBQUM7QUFFL0MsTUFBTSw4QkFBOEIsR0FBRyxXQUFXLENBQUM7QUFDbkQsTUFBTSw4QkFBOEIsR0FBRyxRQUFRLENBQUM7QUFDaEQsTUFBTSxzQkFBc0IsR0FBVyxtQ0FBbUMsQ0FBQztBQUUzRSxNQUFNLGdCQUFnQixHQUFHLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBRXJDLE1BQU0sc0JBQXNCLEdBQUcsR0FBRyxDQUFDO0FBRW5DLE1BQU0sd0JBQXdCLEdBQVksR0FBRyxDQUFDLEVBQUUsQ0FBQyx1QkFBdUIsR0FBRyxHQUFHLENBQUM7QUFDL0UsTUFBTSxpQ0FBaUMsR0FBRywyQkFBMkIsOEJBQThCLEdBQUcsQ0FBQztBQUN2RyxNQUFNLDJCQUEyQixHQUFTLDBCQUEwQiw4QkFBOEIsTUFBTSw4QkFBOEIsR0FBRyxDQUFDO0FBQzFJLE1BQU0sMEJBQTBCLEdBQVUscUJBQXFCLGdCQUFnQixFQUFFLENBQUM7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QyxHQUFHO1FBQ04sT0FBTyxNQUFNLG1CQUFtQixFQUFFLENBQUM7SUFFdkMsSUFBSSxtQkFBRSxDQUFDLEdBQUc7UUFDTixPQUFPLE1BQU0sZUFBZSxFQUFFLENBQUM7SUFFbkMsSUFBSSxtQkFBRSxDQUFDLEtBQUs7UUFDUixPQUFPLE1BQU0saUJBQWlCLEVBQUUsQ0FBQztJQUVyQyxPQUFPLEVBQUUsQ0FBQztBQUNkLENBQUM7QUFHRCxNQUFNO0FBQ047Ozs7Ozs7Ozs7Ozs7Ozs7R0FnQkc7QUFFSDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBcUJHO0FBQ1ksS0FBSztJQUNoQixJQUFJLENBQUMsa0JBQWtCO1FBQ25CLGtCQUFrQixHQUFHLE1BQU0sWUFBWSxFQUFFLENBQUM7SUFFOUMsT0FBTyxrQkFBa0IsQ0FBQztBQUM5QixDQUFDO0FBTEQsNEJBS0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1MgZnJvbSAnb3MtZmFtaWx5JztcbmltcG9ydCB3aGljaCBmcm9tICd3aGljaC1wcm9taXNlJztcbmltcG9ydCB7IG1lcmdlIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBleGlzdHMgZnJvbSAnLi4vdXRpbHMvZnMtZXhpc3RzLXByb21pc2VkJztcbmltcG9ydCB7IGV4ZWMsIGV4ZWNQb3dlcnNoZWxsIH0gZnJvbSAnLi4vdXRpbHMvZXhlYyc7XG5pbXBvcnQgZmluZEFsaWFzIGZyb20gJy4uL3V0aWxzL2ZpbmQtYWxpYXMnO1xuaW1wb3J0IHVucXVvdGUgZnJvbSAnLi4vdXRpbHMvdW5xdW90ZSc7XG5pbXBvcnQgQUxJQVNFUyBmcm9tICcuLi9hbGlhc2VzJztcblxuY29uc3QgTUlDUk9TT0ZUX0VER0VfQ0xBU1MgICAgICA9ICdNaWNyb3NvZnQuTWljcm9zb2Z0RWRnZSc7XG5jb25zdCBNSUNST1NPRlRfRURHRV9LRVlfR0xPQiAgID0gYEhLQ1VcXFxcU29mdHdhcmVcXFxcQ2xhc3Nlc1xcXFxBY3RpdmF0YWJsZUNsYXNzZXNcXFxcUGFja2FnZVxcXFwke01JQ1JPU09GVF9FREdFX0NMQVNTfSpgO1xuY29uc3QgQlJPV1NFUl9DT01NQU5EU19LRVlfR0xPQiA9IHJvb3QgPT4gYCR7cm9vdH1cXFxcU29mdHdhcmVcXFxcQ2xpZW50c1xcXFxTdGFydE1lbnVJbnRlcm5ldFxcXFwqXFxcXHNoZWxsXFxcXG9wZW5cXFxcY29tbWFuZGA7XG5cbmNvbnN0IE1BQ09TX0dFVF9CUk9XU0VSX0xJU1RfQ09NTUFORCA9ICdscyBcIi9BcHBsaWNhdGlvbnMvXCIgfCBncmVwIC1FIFwiQ2hyb21lfEZpcmVmb3h8T3BlcmF8U2FmYXJpfENocm9taXVtfEVkZ2VcIiB8IHNlZCAtRSBcInMvIC8wMzIvXCInO1xuXG5jb25zdCBMSU5FX1dSQVAgICAgICAgID0gJ1xcclxcbic7XG5jb25zdCBET1VCTEVfTElORV9XUkFQID0gTElORV9XUkFQICsgTElORV9XUkFQO1xuXG5jb25zdCBSRUdJU1RSWV9CUk9XU0VSX1BBVEhfUFJPUEVSVFkgPSAnKGRlZmF1bHQpJztcbmNvbnN0IFJFR0lTVFJZX0JST1dTRVJfTkFNRV9QUk9QRVJUWSA9ICdQU1BhdGgnO1xuY29uc3QgUkVHSVNUUllfUFJPUEVSVElFU19SRSAgICAgICAgID0gL14oXFwoZGVmYXVsdFxcKXxQU1BhdGgpXFxzKjpcXHMqKC4rKSQvO1xuXG5jb25zdCBNQVhfT1VUUFVUX1dJRFRIID0gMiAqKiAzMSAtIDE7XG5cbmNvbnN0IFBPV0VSU0hFTExfUElQRV9TWU1CT0wgPSAnfCc7XG5cbmNvbnN0IEdFVF9SRUdJU1RSWV9LRVlfQ09NTUFORCAgICAgICAgICA9IGtleSA9PiBgR2V0LUl0ZW0gJ1JlZ2lzdHJ5Ojoke2tleX0nYDtcbmNvbnN0IEdFVF9CUk9XU0VSX1BBVEhfUFJPUEVSVFlfQ09NTUFORCA9IGBHZXQtSXRlbVByb3BlcnR5IC1OYW1lICcke1JFR0lTVFJZX0JST1dTRVJfUEFUSF9QUk9QRVJUWX0nYDtcbmNvbnN0IEZPUk1BVF9CUk9XU0VSX0lORk9fQ09NTUFORCAgICAgICA9IGBGb3JtYXQtTGlzdCAtUHJvcGVydHkgJyR7UkVHSVNUUllfQlJPV1NFUl9QQVRIX1BST1BFUlRZfScsJyR7UkVHSVNUUllfQlJPV1NFUl9OQU1FX1BST1BFUlRZfSdgO1xuY29uc3QgTElNSVRfT1VUUFVUX1dJRFRIX0NPTU1BTkQgICAgICAgID0gYE91dC1TdHJpbmcgLVdpZHRoICR7TUFYX09VVFBVVF9XSURUSH1gO1xuXG4vLyBOT1RFOiBXZSBoYXZlIHRvIHVzZSBXcml0ZS1Ib3N0IGZvciBjb21wYXRpYmlsaXR5IHdpdGggUG93ZXJTaGVsbCAyLjBcbmNvbnN0IFdSSVRFX0hPU1RfQ09NTUFORCA9ICdXcml0ZS1Ib3N0JztcblxuY29uc3QgR0VUX1JFR0lTVFJZX0JST1dTRVJfUFJPUEVSVElFU19DT01NQU5EID0ga2V5ID0+IFtcbiAgICBHRVRfUkVHSVNUUllfS0VZX0NPTU1BTkQoa2V5KSxcbiAgICBHRVRfQlJPV1NFUl9QQVRIX1BST1BFUlRZX0NPTU1BTkQsXG4gICAgRk9STUFUX0JST1dTRVJfSU5GT19DT01NQU5ELFxuICAgIExJTUlUX09VVFBVVF9XSURUSF9DT01NQU5ELFxuICAgIFdSSVRFX0hPU1RfQ09NTUFORFxuXS5qb2luKFBPV0VSU0hFTExfUElQRV9TWU1CT0wpO1xuXG4vLyBJbnN0YWxsYXRpb24gaW5mbyBjYWNoZVxudmFyIGluc3RhbGxhdGlvbnNDYWNoZSA9IG51bGw7XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFJlZ2lzdHJ5S2V5IChyZWdLZXlHbG9iKSB7XG4gICAgcmV0dXJuIGV4ZWNQb3dlcnNoZWxsKEdFVF9SRUdJU1RSWV9LRVlfQ09NTUFORChyZWdLZXlHbG9iKSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFJlZ2lzdHJ5QnJvd3NlclByb3BlcnRpZXMgKHJlZ0tleUdsb2IpIHtcbiAgICByZXR1cm4gZXhlY1Bvd2Vyc2hlbGwoR0VUX1JFR0lTVFJZX0JST1dTRVJfUFJPUEVSVElFU19DT01NQU5EKHJlZ0tleUdsb2IpKTtcbn1cblxuLy8gRmluZCBpbnN0YWxsYXRpb25zIGZvciBkaWZmZXJlbnQgcGxhdGZvcm1zXG5hc3luYyBmdW5jdGlvbiBhZGRJbnN0YWxsYXRpb24gKGluc3RhbGxhdGlvbnMsIGtleSwgaW5zdFBhdGgpIHtcbiAgICBpZiAoIWF3YWl0IGV4aXN0cyhpbnN0UGF0aCkpXG4gICAgICAgIHJldHVybjtcblxuICAgIGNvbnN0IGRldGVjdGVkQWxpYXMgPSBmaW5kQWxpYXMoa2V5KTtcblxuICAgIGlmICghZGV0ZWN0ZWRBbGlhcylcbiAgICAgICAgcmV0dXJuO1xuXG4gICAgY29uc3QgeyBuYW1lLCBhbGlhczogeyBjbWQsIG1hY09wZW5DbWRUZW1wbGF0ZSwgcGF0aCB9IH0gID0gZGV0ZWN0ZWRBbGlhcztcblxuICAgIGluc3RhbGxhdGlvbnNbbmFtZV0gPSB7IHBhdGg6IHBhdGggfHwgaW5zdFBhdGgsIGNtZCwgbWFjT3BlbkNtZFRlbXBsYXRlIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRldGVjdE1pY3Jvc29mdEVkZ2VMZWdhY3kgKCkge1xuICAgIGNvbnN0IHJlZ2lzdHJ5UmVzdWx0ID0gYXdhaXQgZ2V0UmVnaXN0cnlLZXkoTUlDUk9TT0ZUX0VER0VfS0VZX0dMT0IpO1xuXG4gICAgaWYgKHJlZ2lzdHJ5UmVzdWx0LnN0ZG91dC5pbmNsdWRlcyhNSUNST1NPRlRfRURHRV9DTEFTUykpXG4gICAgICAgIHJldHVybiBBTElBU0VTWydlZGdlLWxlZ2FjeSddO1xuXG4gICAgcmV0dXJuIG51bGw7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNlYXJjaEluUmVnaXN0cnkgKHJlZ2lzdHJ5Um9vdCkge1xuICAgIGNvbnN0IGluc3RhbGxhdGlvbnMgID0ge307XG4gICAgY29uc3QgcmVnaXN0cnlSZXN1bHQgPSAgYXdhaXQgZ2V0UmVnaXN0cnlCcm93c2VyUHJvcGVydGllcyhCUk9XU0VSX0NPTU1BTkRTX0tFWV9HTE9CKHJlZ2lzdHJ5Um9vdCkpO1xuXG4gICAgY29uc3QgZGF0YSA9IHJlZ2lzdHJ5UmVzdWx0LnN0ZG91dFxuICAgICAgICAuc3BsaXQoRE9VQkxFX0xJTkVfV1JBUClcbiAgICAgICAgLm1hcChibG9jayA9PiBibG9ja1xuICAgICAgICAgICAgLnNwbGl0KExJTkVfV1JBUClcbiAgICAgICAgICAgIC5tYXAobGluZSA9PiBsaW5lLm1hdGNoKFJFR0lTVFJZX1BST1BFUlRJRVNfUkUpKVxuICAgICAgICAgICAgLmZpbHRlcihtYXRjaCA9PiAhIW1hdGNoKVxuICAgICAgICAgICAgLm1hcChtYXRjaCA9PiAoe1xuICAgICAgICAgICAgICAgIFttYXRjaFsxXV06IHVucXVvdGUobWF0Y2hbMl0pXG4gICAgICAgICAgICB9KSlcbiAgICAgICAgKVxuICAgICAgICAuZmlsdGVyKGJsb2NrID0+IGJsb2NrICYmIGJsb2NrLmxlbmd0aClcbiAgICAgICAgLm1hcChibG9jayA9PiBtZXJnZSguLi5ibG9jaykpO1xuXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoZGF0YS5tYXAocmVjb3JkID0+IGFkZEluc3RhbGxhdGlvbihpbnN0YWxsYXRpb25zLCByZWNvcmRbUkVHSVNUUllfQlJPV1NFUl9OQU1FX1BST1BFUlRZXSwgcmVjb3JkW1JFR0lTVFJZX0JST1dTRVJfUEFUSF9QUk9QRVJUWV0pKSk7XG5cbiAgICByZXR1cm4gaW5zdGFsbGF0aW9ucztcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmluZFdpbmRvd3NCcm93c2VycyAoKSB7XG4gICAgY29uc3QgbWFjaGluZVJlZ2lzdGVyZWRCcm93c2VycyA9IGF3YWl0IHNlYXJjaEluUmVnaXN0cnkoJ0hLRVlfTE9DQUxfTUFDSElORScpO1xuICAgIGNvbnN0IHVzZXJSZWdpc3RlcmVkQnJvd3NlcnMgICAgPSBhd2FpdCBzZWFyY2hJblJlZ2lzdHJ5KCdIS0VZX0NVUlJFTlRfVVNFUicpO1xuICAgIGNvbnN0IGluc3RhbGxhdGlvbnMgICAgICAgICAgICAgPSBPYmplY3QuYXNzaWduKG1hY2hpbmVSZWdpc3RlcmVkQnJvd3NlcnMsIHVzZXJSZWdpc3RlcmVkQnJvd3NlcnMpO1xuICAgIGNvbnN0IGVkZ2VMZWdhY3kgICAgICAgICAgICAgICAgPSBhd2FpdCBkZXRlY3RNaWNyb3NvZnRFZGdlTGVnYWN5KCk7XG5cbiAgICBpZiAoZWRnZUxlZ2FjeSlcbiAgICAgICAgaW5zdGFsbGF0aW9uc1snZWRnZS1sZWdhY3knXSA9IGVkZ2VMZWdhY3k7XG5cbiAgICBpZiAoZWRnZUxlZ2FjeSAmJiAhaW5zdGFsbGF0aW9uc1snZWRnZSddKVxuICAgICAgICBpbnN0YWxsYXRpb25zWydlZGdlJ10gPSBlZGdlTGVnYWN5O1xuXG4gICAgcmV0dXJuIGluc3RhbGxhdGlvbnM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpbmRNYWNCcm93c2VycyAoKSB7XG4gICAgdmFyIGluc3RhbGxhdGlvbnMgPSB7fTtcblxuICAgIC8vIE5PVEU6IHJlcGxhY2UgdGhlIHNwYWNlIHN5bWJvbCB3aXRoIGNvZGUsIGJlY2F1c2UgZ3JlcCBzcGxpdHMgc3RyaW5ncyBieSBzcGFjZS5cbiAgICB2YXIgc3Rkb3V0ID0gYXdhaXQgZXhlYyhNQUNPU19HRVRfQlJPV1NFUl9MSVNUX0NPTU1BTkQpO1xuXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoc3Rkb3V0XG4gICAgICAgIC5zcGxpdCgnXFxuJylcbiAgICAgICAgLmZpbHRlcihmaWxlTmFtZSA9PiAhIWZpbGVOYW1lKVxuICAgICAgICAubWFwKGZpbGVOYW1lID0+IHtcbiAgICAgICAgICAgIC8vIE5PVEU6IHJlc3RvcmUgc3BhY2VcbiAgICAgICAgICAgIGZpbGVOYW1lID0gZmlsZU5hbWUucmVwbGFjZSgvMDMyL2csICcgJyk7XG5cbiAgICAgICAgICAgIHZhciBuYW1lID0gZmlsZU5hbWUucmVwbGFjZSgvLmFwcCQvLCAnJyk7XG4gICAgICAgICAgICB2YXIgcGF0aCA9IGAvQXBwbGljYXRpb25zLyR7ZmlsZU5hbWV9YDtcblxuICAgICAgICAgICAgcmV0dXJuIGFkZEluc3RhbGxhdGlvbihpbnN0YWxsYXRpb25zLCBuYW1lLCBwYXRoKTtcbiAgICAgICAgfSkpO1xuXG4gICAgcmV0dXJuIGluc3RhbGxhdGlvbnM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpbmRMaW51eEJyb3dzZXJzICgpIHtcbiAgICB2YXIgaW5zdGFsbGF0aW9ucyA9IHt9O1xuXG4gICAgdmFyIGFsaWFzQ2hlY2tpbmdQcm9taXNlcyA9IE9iamVjdFxuICAgICAgICAua2V5cyhBTElBU0VTKVxuICAgICAgICAubWFwKG5hbWUgPT4ge1xuICAgICAgICAgICAgdmFyIHsgbGludXhCaW5hcmllcyB9ID0gQUxJQVNFU1tuYW1lXTtcblxuICAgICAgICAgICAgaWYgKCFsaW51eEJpbmFyaWVzKVxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuXG4gICAgICAgICAgICB2YXIgZGV0ZWN0aW9uUHJvbWlzZXMgPSBsaW51eEJpbmFyaWVzXG4gICAgICAgICAgICAgICAgLm1hcChiaW5hcnkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2hpY2goYmluYXJ5KVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4ocGF0aCA9PiBhZGRJbnN0YWxsYXRpb24oaW5zdGFsbGF0aW9ucywgbmFtZSwgcGF0aCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5PVEU6IGJpbmFyeSBub3QgZm91bmQsIGp1c3QgZG8gbm90aGluZ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoZGV0ZWN0aW9uUHJvbWlzZXMpO1xuICAgICAgICB9KTtcblxuICAgIGF3YWl0IFByb21pc2UuYWxsKGFsaWFzQ2hlY2tpbmdQcm9taXNlcyk7XG5cbiAgICByZXR1cm4gaW5zdGFsbGF0aW9ucztcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmluZEJyb3dzZXJzICgpIHtcbiAgICBpZiAoT1Mud2luKVxuICAgICAgICByZXR1cm4gYXdhaXQgZmluZFdpbmRvd3NCcm93c2VycygpO1xuXG4gICAgaWYgKE9TLm1hYylcbiAgICAgICAgcmV0dXJuIGF3YWl0IGZpbmRNYWNCcm93c2VycygpO1xuXG4gICAgaWYgKE9TLmxpbnV4KVxuICAgICAgICByZXR1cm4gYXdhaXQgZmluZExpbnV4QnJvd3NlcnMoKTtcblxuICAgIHJldHVybiB7fTtcbn1cblxuXG4vLyBBUElcbi8qKiBAdHlwZWRlZiB7T2JqZWN0fSBCcm93c2VySW5mb1xuICogQGRlc2NyaXB0aW9uIE9iamVjdCB0aGF0IGNvbnRhaW5zIGluZm9ybWF0aW9uIGFib3V0IHRoZSBicm93c2VyIGluc3RhbGxlZCBvbiB0aGUgbWFjaGluZS5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfHVuZGVmaW5lZH0gcGF0aCAtIFRoZSBwYXRoIHRvIHRoZSBleGVjdXRhYmxlIGZpbGUgdGhhdCBzdGFydHMgdGhlIGJyb3dzZXIuXG4gKiAgUmVxdWlyZWQgb24gTWFjT1MgbWFjaGluZXMuIE9uIFdpbmRvd3MgbWFjaGluZXMsIGl0IGlzIHVzZWQgd2hlbiB0aGUgd2luT3BlbkNtZFRlbXBsYXRlIHByb3BlcnR5IGlzIHVuZGVmaW5lZC5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjbWQgLSBBZGRpdGlvbmFsIGNvbW1hbmQgbGluZSBwYXJhbWV0ZXJzLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IG1hY09wZW5DbWRUZW1wbGF0ZSAtIEEgW011c3RhY2hlIHRlbXBsYXRlXShodHRwczovL2dpdGh1Yi5jb20vamFubC9tdXN0YWNoZS5qcyN0ZW1wbGF0ZXMpXG4gKiAgdGhhdCBwcm92aWRlcyBwYXJhbWV0ZXJzIGZvciBsYXVuY2hpbmcgdGhlIGJyb3dzZXIgb24gYSBNYWNPUyBtYWNoaW5lLlxuICogQHByb3BlcnR5IHtzdHJpbmd8dW5kZWZpbmVkfSB3aW5PcGVuQ21kVGVtcGxhdGUgLSBBIFtNdXN0YWNoZSB0ZW1wbGF0ZV0oaHR0cHM6Ly9naXRodWIuY29tL2phbmwvbXVzdGFjaGUuanMjdGVtcGxhdGVzKVxuICogIHRoYXQgcHJvdmlkZXMgcGFyYW1ldGVycyBmb3IgbGF1bmNoaW5nIHRoZSBicm93c2VyIG9uIGEgV2luZG93cyBtYWNoaW5lLiAgSWYgdW5kZWZpbmVkLCB0aGUgcGF0aCB0byB0aGVcbiAqICBleGVjdXRhYmxlIGZpbGUgc3BlY2lmaWVkIGJ5IHRoZSBwYXRoIHByb3BlcnR5IGlzIHVzZWQuXG4gKiBAZXhhbXBsZVxuICogIHtcbiAqICAgICAgIHBhdGg6ICdDOlxcXFxQcm9ncmFtRmlsZXNcXFxcLi4uXFxcXGZpcmVmb3guZXhlJyxcbiAqICAgICAgIGNtZDogJy1uZXctd2luZG93JyxcbiAqICAgICAgIG1hY09wZW5DbWRUZW1wbGF0ZTogJ29wZW4gLWEgXCJ7e3twYXRofX19XCIge3t7cGFnZVVybH19fSAtLWFyZ3Mge3t7Y21kfX19J1xuICogIH1cbiAqL1xuXG4vKipcbiAqIFJldHVybnMgdGhlIGxpc3Qgb2YgdGhlIHtAbGluayBCcm93c2VySW5mb30gb2JqZWN0cyB0aGF0IGNvbnRhaW4gaW5mb3JtYXRpb24gYWJvdXQgdGhlIGJyb3dzZXJzIGluc3RhbGxlZCBvbiB0aGUgbWFjaGluZS5cbiAqIEBmdW5jdGlvblxuICogQGFzeW5jXG4gKiBAbmFtZSBnZXRJbnN0YWxsYXRpb25zXG4gKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsIEJyb3dzZXJJbmZvPn0gTGlzdCBvZiB0aGUge0BsaW5rIEJyb3dzZXJJbmZvfSBvYmplY3RzXG4gKiAgIGNvbnRhaW5pbmcgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGJyb3dzZXJzIGluc3RhbGxlZCBvbiB0aGUgbWFjaGluZS5cbiAqIEBleGFtcGxlXG4gKiB7XG4gKiAgIGNocm9tZToge1xuICogICAgICAgcGF0aDogJ0M6XFxcXFByb2dyYW1GaWxlc1xcXFwuLi5cXFxcY2hyb21lLmV4ZScsXG4gKiAgICAgICBjbWQ6ICctLW5ldy13aW5kb3cnLFxuICogICAgICAgbWFjT3BlbkNtZFRlbXBsYXRlOiAnb3BlbiAtbiAtYSBcInt7e3BhdGh9fX1cIiAtLWFyZ3Mge3t7cGFnZVVybH19fSB7e3tjbWR9fX0nXG4gKiAgIH0sXG4gKlxuICogICBmaXJlZm94OiB7XG4gKiAgICAgICBwYXRoOiAnQzpcXFxcUHJvZ3JhbUZpbGVzXFxcXC4uLlxcXFxmaXJlZm94LmV4ZScsXG4gKiAgICAgICBjbWQ6ICctbmV3LXdpbmRvdycsXG4gKiAgICAgICBtYWNPcGVuQ21kVGVtcGxhdGU6ICdvcGVuIC1hIFwie3t7cGF0aH19fVwiIHt7e3BhZ2VVcmx9fX0gLS1hcmdzIHt7e2NtZH19fSdcbiAqICAgfVxuICogfVxuICovXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKCFpbnN0YWxsYXRpb25zQ2FjaGUpXG4gICAgICAgIGluc3RhbGxhdGlvbnNDYWNoZSA9IGF3YWl0IGZpbmRCcm93c2VycygpO1xuXG4gICAgcmV0dXJuIGluc3RhbGxhdGlvbnNDYWNoZTtcbn1cbiJdfQ==